<p-tabMenu [model]="tabs" [activeItem]="activeTab"></p-tabMenu>

<div *ngIf="activeTab.label === 'Jobs'">
  <div class="p-grid" style="margin-top: 0;">
    <div class="p-col-5">

      <div style="margin: 0 0 10px 0; display: flex; justify-content: space-between;">
        <p-button label="Refresh" (onClick)="refreshJobs(jobsTable)"></p-button>
        <div>
          <p-inputSwitch [(ngModel)]="includeCovered" [style]="{'vertical-align': 'middle'}" (onChange)="coveredChange()"></p-inputSwitch> Covered
        </div>
      </div>

      <p-table #jobsTable
               id="jobs"
               [value]="jobs"
               [lazy]="true"
               selectionMode="single"
               [(selection)]="job"
               (onLazyLoad)="loadJobsLazy($event)"
               [paginator]="true"
               [rows]="30"
               [totalRecords]="totalJobs"
               [loading]="loadingJobs"
               (onRowSelect)="jobSelected($event)"
               [rowsPerPageOptions]="[10,20,30,50,100]"
               [showCurrentPageReport]="true">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 60px;">Job ID</th>
            <th style="width: 120px;">Job Name</th>
            <th style="width: 100px;">State</th>
            <th style="width: 100px;">Completion Status</th>
            <th style="width: 30%;">System</th>
            <th style="width: 10%;">Config</th>
            <th style="width: 10%; overflow-x: hidden;">Executor Group</th>
            <th style="width: 10%; overflow-x: hidden;">Executor</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-job>
          <tr [pSelectableRow]="job" [ngStyle]="{'background-color': job.covered ? '#aa9' : ''}">
            <td><a routerLink="/jobs/{{job.job_id}}">{{job.id}}</a></td>
            <td>{{job.name}}</td>
            <td>{{getJobState(job)}}</td>
            <td>
              <i style="vertical-align: bottom; font-size: 1.4em;" [ngClass]="getJobStatusClass(job)"></i>{{getJobStatus(job)}}
            </td>
            <td>Ubuntu 18.04</td>
            <td>default</td>
            <td>{{job.executor_group_name}}</td>
            <td>{{job.executor_name}}</td>
          </tr>
        </ng-template>
      </p-table>

    </div>

    <div class="p-col-7">
      <div *ngIf="job">
        <div style="margin: 10px 0;">
          <span style="font-size: 1.2rem; font-weight: bold; margin-right: 20px;">{{job.id}}. {{ job.name }}</span>
          <span>Started: {{ job.started ? (job.started | localtime) : 'not yet' }}</span>
          <span style="margin-left: 30px;">Completed: {{ job.completed ? (job.completed | localtime) : 'not yet' }}</span>
        </div>

        <p-tabView>
          <p-tabPanel header="Logs">
            <app-log-box [jobId]="selectedJobId"></app-log-box>
          </p-tabPanel>
          <p-tabPanel header="Steps">
            <div *ngFor="let step of job.steps" style="margin-bottom: 10px;">
              <div style="font-size: 1.5em; font-weight: bold">{{ step.index + 1 }}. {{ step.tool }}</div>
              Status: <i style="vertical-align: bottom; font-size: 1.4em;" [ngClass]="getStepStatusClass(step)"></i>{{ getStepStatus(step) }}
              <div *ngIf="step.status === 3">
                Reason: {{ step.result['reason'] }}
                <pre>{{ step.result['msg'] }}</pre>
              </div>
            </div>
          </p-tabPanel>
        </p-tabView>

      </div>
    </div>
  </div>
</div>


<div *ngIf="activeTab.label === 'Test Results'" style="margin-top: 5px;">
      <p-table #resultsTable
             id="results"
             [value]="results"
             [lazy]="true"
             (onLazyLoad)="loadResultsLazy($event)"
             [paginator]="true"
             [rows]="30"
             [totalRecords]="totalResults"
             [loading]="loadingResults"
             [rowsPerPageOptions]="[10,20,30,50,100]"
             [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 150px;">Job Name</th>
          <th style="width: 60px;">Job ID</th>
          <th style="width: 100px;">Result</th>
          <th style="width: 70px;">Change</th>
          <th style="width: 50%;">Name</th>
          <th style="width: 40px;">Age</th>
          <th style="width: 40px; overflow-x: hidden;">Instability</th>
          <th style="width: 150px;">Values</th>
          <th style="width: 30%;">System</th>
          <th style="width: 10%;">Config</th>
          <th style="width: 10%;">Executor Group</th>
          <th style="width: 10%;">Executor</th>
          <th style="width: 90px;">Cmd Line</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-res>
        <tr>
          <td>{{res.job_name}}</td>
          <td><a routerLink="/jobs/{{res.job_id}}">{{res.job_id}}</a></td>
          <td [class]="resultToClass(res.result)">{{resultToTxt(res.result)}}</td>
          <td>{{res.change}}</td>
          <td><a routerLink="/test_case_results/{{res.id}}">{{res.test_case_name}}</a></td>
          <td>{{res.age}}</td>
          <td>{{res.instability}}</td>
          <td>
            <div *ngFor="let v of res.values | keyvalue">
              {{v.key}}:&nbsp;{{v.value.value}}
            </div>
          </td>
          <td>Ubuntu 18.04</td>
          <td>default</td>
          <td>{{res.executor_group_name}}</td>
          <td>{{res.executor_name}}</td>
          <td><p-button label="CmdLine" (onClick)="showCmdLine()" styleClass="cmd-line-btn"></p-button></td>
        </tr>
      </ng-template>
    </p-table>
</div>


<div *ngIf="activeTab.label === 'Issues'" style="margin-top: 5px;">
    <p-table id="issues"
             [value]="issues"
             [lazy]="true"
             (onLazyLoad)="loadIssuesLazy($event)"
             [paginator]="true"
             [rows]="30"
             [totalRecords]="totalIssues"
             [loading]="loadingIssues"
             [rowsPerPageOptions]="[10,20,30,50,100]"
             [showCurrentPageReport]="true">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 150px;">Job Name</th>
          <th style="width: 60px;">Job ID</th>
          <th style="width: 100px;">Type</th>
          <th style="width: 20%;">Location</th>
          <th style="width: 20%;">Message</th>
          <th style="width: 180px;">Symbol</th>
          <th style="width: 20%;">System</th>
          <th style="width: 10%;">Config</th>
          <th style="width: 10%;">Executor Group</th>
          <th style="width: 10%;">Executor</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-issue>
        <tr>
          <td>{{ issue.job_name }}</td>
          <td><a routerLink="/jobs/{{ issue.job_id }}">{{ issue.job_id }}</a></td>
          <td [class]="issueTypeToClass(issue.issue_type)">{{issueTypeToTxt(issue.issue_type)}}</td>
          <td>
            <a *ngIf="issue.url" href="{{ issue.url }}" target="blank">
              {{ issue.path }}:{{ issue.line }}:{{ issue.column }}
            </a>
            <span *ngIf="!issue.url">
              {{ issue.path }}:{{ issue.line }}:{{ issue.column }}
            </span>
          </td>
          <td>{{ issue.message }}</td>
          <td>{{ issue.symbol }}</td>
          <td>Ubuntu 18.04</td>
          <td>default</td>
          <td>{{ issue.executor_group_name}}</td>
          <td>{{ issue.executor_name}}</td>
        </tr>
      </ng-template>
    </p-table>
</div>
